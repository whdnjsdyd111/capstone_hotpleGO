<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{user/default}">
<th:block layout:fragment="styles">
    <style>
        .c-index {
            border-radius: 50px;
            height: 50px;
            width: 50px;
            font-size: xx-large;
        }

        .m-index {
            border-radius: 25px;
            height: 25px;
            width: 25px;
        }
    </style>
</th:block>
<div layout:fragment="content">
    <div th:replace="user/courceNav :: cource"></div>
    <div class="container my-2">
        <div id="map_div"></div>
    </div>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=l7xxcd9bdd0942b542fd8c7be931fc11a3b4"></script>
    <script>
        // 0. 인덱스 색 및 총 거리
        let colors = [
            '#e12717',
            '#ffa400',
            '#00dd1c',
            '#1E90FF'
        ];
        let total_distance = 0;

        // 1. 지도 띄우기
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(37.52084364186228,127.058908811749),
            width: "100%",
            height: "400px"
        });

        let new_polyLine = [];
        let new_Click_polyLine = [];

        function drawData(data){
            // 지도위에 선은 다 지우기
            routeData = data;
            let resultStr = "";
            let distance = 0;
            let idx = 1;
            let newData = [];
            let equalData = [];
            let pointId1 = "-1234567";
            let ar_line = [];

            for (let i = 0; i < data.features.length; i++) {
                let feature = data.features[i];
                //배열에 경로 좌표 저잘
                if(feature.geometry.type == "LineString"){
                    ar_line = [];
                    for (let j = 0; j < feature.geometry.coordinates.length; j++) {
                        let startPt = new Tmapv2.LatLng(feature.geometry.coordinates[j][1],feature.geometry.coordinates[j][0]);
                        ar_line.push(startPt);
                        pointArray.push(feature.geometry.coordinates[j]);
                    }
                    let polyline = new Tmapv2.Polyline({
                        path: ar_line,
                        strokeColor: "#ff0000",
                        strokeWeight: 6,
                        map: map
                    });
                    new_polyLine.push(polyline);
                }
                let pointId2 = feature.properties.viaPointId;
                if (pointId1 != pointId2) {
                    equalData = [];
                    equalData.push(feature);
                    newData.push(equalData);
                    pointId1 = pointId2;
                } else {
                    equalData.push(feature);
                }
            }
            geoData = newData;
            let markerCnt = 1;
            for (let i = 0; i < newData.length; i++) {
                let mData = newData[i];
                let type = mData[0].geometry.type;
                let pointType = mData[0].properties.pointType;
                let pointTypeCheck = false; // 경유지 일때만 true
                if (mData[0].properties.pointType == "S") {
                    let img = 'http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png';
                    let lon = mData[0].geometry.coordinates[0];
                    let lat = mData[0].geometry.coordinates[1];
                } else if (mData[0].properties.pointType == "E") {
                    let img = 'http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_e.png';
                    let lon = mData[0].geometry.coordinates[0];
                    let lat = mData[0].geometry.coordinates[1];
                } else {
                    markerCnt=i;
                    let lon = mData[0].geometry.coordinates[0];
                    let lat = mData[0].geometry.coordinates[1];
                }
            }
        }

        // 2. 시작, 도착 심볼찍기

        let markerList = [];
        let pointArray = [];

        // 시작
        addMarker("llStart",127.02810900563199,37.519892712436906,1);
        // 도착
        addMarker("llEnd",127.11971717230388,37.49288934463672,4);
        function addMarker(status, lon, lat, index) {
            let marker = new Tmapv2.Marker({
                position: new Tmapv2.LatLng(lat,lon),
                iconHTML: '<p class="m-index font-weight-bold" style="background-color: ' + colors[index - 1] + '">' + index + '</p>',
                map: map
            });
            // 마커 드래그 설정
            marker.tag = index;
            marker.addListener("dragend", function (evt) {
                markerListenerEvent(evt);
            });
            marker.addListener("drag", function (evt) {
                markerObject = markerList[index];
            });
            markerList[index] = marker;
            return marker;
        }

        // 3. 경유지 심볼 찍기
        addMarker("llPass",127.07389565460413,37.5591696189164,2);
        addMarker("llPass",127.13346617572014,37.52127761904626,3);


        // 4. 경로탐색 API 사용요청
        var startX = 127.02810900563199;
        var startY = 37.519892712436906;
        var endX = 127.11971717230388;
        var endY = 37.49288934463672;
        var passList = "127.07389565460413,37.5591696189164_127.13346617572014,37.52127761904626";
        var prtcl;
        var headers = {};
        headers["appKey"]='l7xxcd9bdd0942b542fd8c7be931fc11a3b4';
        $.ajax({
            method:"POST",
            headers : headers,
            url:"https://apis.openapi.sk.com/tmap/routes?version=1&format=json",//
            async:false,
            data:{
                startX : startX,
                startY : startY,
                endX : endX,
                endY : endY,
                passList : passList,
                reqCoordType : "WGS84GEO",
                resCoordType : "WGS84GEO",
                angle : "172",
                searchOption : "0",
                trafficInfo : "Y"
            },
            success:function(response){
                prtcl = response;

                // 5. 경로탐색 결과 Line 그리기
                let trafficColors = {
                    extractStyles:true,
                    /* 실제 교통정보가 표출되면 아래와 같은 Color로 Line이 생성됩니다. */
                    trafficDefaultColor:"#636f63", //Default
                    trafficType1Color:"#19b95f", //원할
                    trafficType2Color:"#f15426", //지체
                    trafficType3Color:"#ff970e"  //정체
                };
                let style_red = {
                    fillColor:"#FF0000",
                    fillOpacity:0.2,
                    strokeColor: "#FF0000",
                    strokeWidth: 3,
                    strokeDashstyle: "solid",
                    pointRadius: 2,
                    title: "this is a red line"
                };
                drawData(prtcl);


                // 6. 경로탐색 결과 반경만큼 지도 레벨 조정
                let newData = geoData[0];
                PTbounds = new Tmapv2.LatLngBounds();
                let latlon;
                for (let i = 0; i < newData.length; i++) {
                    let mData = newData[i];
                    let type = mData.geometry.type;
                    let pointType = mData.properties.pointType;
                    if(type == "Point"){
                        let linePt = new Tmapv2.LatLng(mData.geometry.coordinates[1],mData.geometry.coordinates[0]);
                        console.log(linePt);
                        if (latlon === undefined) {
                            latlon = linePt;
                        } else {
                            total_distance += latlon.distanceTo(linePt);
                            latlon = linePt;
                        }
                        PTbounds.extend(linePt);
                    } else{
                        let startPt,endPt;
                        for (let j = 0; j < mData.geometry.coordinates.length; j++) {
                            let linePt = new Tmapv2.LatLng(mData.geometry.coordinates[j][1],mData.geometry.coordinates[j][0]);
                            console.log(linePt);
                            if (latlon === undefined) {
                                latlon = linePt;
                            } else {
                                total_distance += latlon.distanceTo(linePt);
                                latlon = linePt;
                            }
                            PTbounds.extend(linePt);
                        }
                    }
                }
                console.log("총 거리 : " + total_distance + " m");
                map.fitBounds(PTbounds);
            },
            error:function(request,status,error){
                console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });

    </script>
    <div class="container">
        <div class="d-flex flex-column my-3">
            <div class="my-3">
                <span class="font-weight-bold mx-5">함께하는 사람 : 친구</span>
                <span class="font-weight-bold mx-5">인원 : 3명</span>
            </div>
            <hr class="col"/>
            <div class="d-flex justify-content-around my-3">
                <span class="my-auto c-index font-weight-bold" style="background-color: #e12717">1</span>
                <img height="300" width="300" alt="이미지 없음" src="">
                <div class="d-flex flex-column my-auto">
                    <span>가게 이름 ( 대략 소요 시간 30분)</span>
                    <span>도로명 주소</span>
                </div>
            </div>
            <hr class="col"/>
            <div class="d-flex justify-content-around my-3">
                <span class="my-auto c-index font-weight-bold" style="background-color: #ffa400">2</span>
                <img height="300" width="300" alt="이미지 없음" src="">
                <div class="d-flex flex-column my-auto">
                    <span>가게 이름 ( 대략 소요 시간 30분)</span>
                    <span>도로명 주소</span>
                </div>
            </div>
            <hr class="col"/>
            <div class="d-flex justify-content-around my-3">
                <span class="my-auto c-index font-weight-bold" style="background-color: #00dd1c">3</span>
                <img height="300" width="300" alt="이미지 없음" src="">
                <div class="d-flex flex-column my-auto">
                    <span>가게 이름 ( 대략 소요 시간 30분)</span>
                    <span>도로명 주소</span>
                </div>
            </div>
            <hr class="col"/>
            <div class="d-flex justify-content-around my-3">
                <span class="my-auto c-index font-weight-bold" style="background-color: #1E90FF">3</span>
                <img height="300" width="300" alt="이미지 없음" src="">
                <div class="d-flex flex-column my-auto">
                    <span>가게 이름 ( 대략 소요 시간 30분)</span>
                    <span>도로명 주소</span>
                </div>
            </div>
            <hr class="col"/>
        </div>
    </div>
</div>
</html>